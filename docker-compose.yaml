version: '3.7'

services:
  # MinIO Nodes
  minio1:
    image: quay.io/minio/minio:latest
    hostname: minio1
    volumes:
      - minio1-data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server http://minio{1...3}/data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - monitoring_default

  minio2:
    image: quay.io/minio/minio:latest
    hostname: minio2
    volumes:
      - minio2-data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server http://minio{1...3}/data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - monitoring_default

  minio3:
    image: quay.io/minio/minio:latest
    hostname: minio3
    volumes:
      - minio3-data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server http://minio{1...3}/data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - monitoring_default

  # HAProxy Load Balancer
  haproxy:
    image: haproxy:2.6
    hostname: haproxy
    ports:
      - "9000:9000"  # MinIO API
      - "9001:9001"  # MinIO Console
      - "3100:3100"  # Loki Load-balanced port
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - minio1
      - minio2
      - minio3
    networks:
      monitoring_default:
        aliases:
          - loki-data.haproxy  # Added for backward compatibility

  # Loki Cluster Nodes
  loki1:
    image: grafana/loki:2.9.2
    hostname: loki1
    ports:
      - "3101:3100"
    volumes:
      - ./loki-config.yaml:/etc/loki/config.yaml
      - loki1-wal:/wal
      - loki1-cache:/loki
    command: -config.file=/etc/loki/config.yaml
    depends_on:
      - haproxy
      - minio1
      - minio2
      - minio3
    networks:
      - monitoring_default

  loki2:
    image: grafana/loki:2.9.2
    hostname: loki2
    ports:
      - "3102:3100"
    volumes:
      - ./loki-config.yaml:/etc/loki/config.yaml
      - loki2-wal:/wal
      - loki2-cache:/loki
    command: -config.file=/etc/loki/config.yaml
    depends_on:
      - haproxy
      - minio1
      - minio2
      - minio3
    networks:
      - monitoring_default

  loki3:
    image: grafana/loki:2.9.2
    hostname: loki3
    ports:
      - "3103:3100"
    volumes:
      - ./loki-config.yaml:/etc/loki/config.yaml
      - loki3-wal:/wal
      - loki3-cache:/loki
    command: -config.file=/etc/loki/config.yaml
    depends_on:
      - haproxy
      - minio1
      - minio2
      - minio3
    networks:
      - monitoring_default

  # Grafana
  grafana:
    image: grafana/grafana:10.2.3
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-storage:/var/lib/grafana
    depends_on:
      - loki1
    networks:
      - monitoring_default

volumes:
  minio1-data:
  minio2-data:
  minio3-data:
  loki1-wal:
  loki2-wal:
  loki3-wal:
  loki1-cache:
  loki2-cache:
  loki3-cache:
  grafana-storage:

networks:
  monitoring_default:
    external: true
